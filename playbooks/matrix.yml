---
- name: Deploy Matrix server only
  hosts: matrix_servers
  become: yes
  gather_facts: yes

  pre_tasks:
    - name: Check if system is hardened
      stat:
        path: /etc/ssh/sshd_config
      register: ssh_config

    - name: Warning about system hardening
      debug:
        msg: |
          ⚠️  WARNING: It's recommended to run the hardening playbook first!
          Run: ansible-playbook playbooks/hardening.yml
      when: ssh_config.stat.exists and (ssh_config.stat.mode != '0644' or ansible_ssh_port != (ssh_port | default(2222)))

    - name: Verify required variables
      assert:
        that:
          - matrix_domain is defined
          - matrix_homeserver_name is defined
          - ssl_email is defined
        fail_msg: "Required Matrix variables not defined. Check your inventory."

  roles:
    - role: ssl_certificates
      vars:
        ssl_domains:
          - "{{ matrix_domain }}"
          - "{{ matrix_homeserver_name }}"
      tags: ['ssl']

    - role: caddy
      tags: ['webserver', 'proxy']

    - role: matrix_server
      tags: ['matrix', 'synapse', 'element', 'coturn']

  post_tasks:
    - name: Wait for Synapse to start
      wait_for:
        port: 8008
        host: localhost
        timeout: 60
      tags: ['verification']

    - name: Test Matrix server health
      uri:
        url: "http://localhost:8008/_matrix/client/versions"
        method: GET
        status_code: 200
      register: matrix_health
      retries: 5
      delay: 10
      tags: ['verification']

    - name: Test federation endpoint
      uri:
        url: "https://{{ matrix_homeserver_name }}/_matrix/federation/v1/version"
        method: GET
        status_code: 200
        validate_certs: yes
      register: federation_test
      ignore_errors: yes
      tags: ['verification']

    - name: Display Matrix deployment results
      debug:
        msg: |
          =====================================
          MATRIX SERVER DEPLOYMENT STATUS
          =====================================

          🏠 Homeserver: {{ matrix_homeserver_name }}
          🌐 Domain: {{ matrix_domain }}
          ⚡ Status: {{ 'Online' if matrix_health.status == 200 else 'Error' }}
          🔗 Federation: {{ 'Working' if federation_test.status == 200 else 'Check DNS/SSL' }}

          📱 Client Access:
          - Element Web: https://{{ matrix_domain }}
          - Any Matrix client: {{ matrix_homeserver_name }}

          🔧 Admin Commands:
          - Create admin user: /usr/local/bin/create-matrix-admin.sh <user> <pass>
          - View logs: journalctl -u matrix-synapse -f
          - Check status: systemctl status matrix-synapse

          📋 Testing:
          - Internal health: ✅ {{ 'Pass' if matrix_health.status == 200 else 'Fail' }}
          - Federation test: {{ '✅ Pass' if federation_test.status == 200 else '❌ Fail' }}
          - Federation tester: https://federationtester.matrix.org/

          📁 Configuration Files:
          - Main config: /etc/matrix-synapse/homeserver.yaml
          - Element config: {{ matrix_element_path }}/config.json
          - Caddy config: /etc/caddy/Caddyfile
          - Coturn config: /etc/turnserver.conf

          {% if federation_test.status != 200 %}
          ⚠️  Federation Issues:
          - Check DNS records for {{ matrix_homeserver_name }}
          - Verify SSL certificate
          - Check firewall rules for port 8448
          - Test with: curl https://{{ matrix_homeserver_name }}/_matrix/federation/v1/version
          {% endif %}
      tags: ['summary']