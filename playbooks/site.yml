---
- name: Deploy secure Matrix server infrastructure
  hosts: matrix_servers
  become: yes
  gather_facts: yes
  vars_prompt:
    - name: confirm_deployment
      prompt: "This will deploy a complete Matrix server setup. Continue? (yes/no)"
      private: no

  pre_tasks:
    - name: Verify deployment confirmation
      fail:
        msg: "Deployment cancelled by user"
      when: confirm_deployment != "yes"

    - name: Check required variables
      assert:
        that:
          - matrix_domain is defined
          - matrix_homeserver_name is defined
          - ssl_email is defined
        fail_msg: "Required variables not set. Please check your inventory configuration."

    - name: Verify SSH connectivity
      ping:

    - name: Check if we can become root
      command: whoami
      become: yes
      changed_when: false

  roles:
    - role: user_management
      tags: ['users', 'ssh', 'security']

    - role: debian_hardening
      tags: ['hardening', 'security']

    - role: firewall
      tags: ['firewall', 'security']

    - role: ssl_certificates
      vars:
        ssl_domains:
          - "{{ matrix_domain }}"
          - "{{ matrix_homeserver_name }}"
      tags: ['ssl', 'certificates']

    - role: monitoring
      tags: ['monitoring', 'metrics']

    - role: caddy
      tags: ['webserver', 'proxy']

    - role: matrix_server
      tags: ['matrix', 'synapse', 'element']

  post_tasks:
    - name: Verify Matrix services are running
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - matrix-synapse
        - caddy
        - postgresql
        - redis-server
      tags: ['verification']

    - name: Check Matrix federation
      uri:
        url: "https://{{ matrix_homeserver_name }}/_matrix/federation/v1/version"
        method: GET
        status_code: 200
      register: federation_check
      ignore_errors: yes
      tags: ['verification']

    - name: Display deployment summary
      debug:
        msg: |
          =====================================
          MATRIX SERVER DEPLOYMENT COMPLETE
          =====================================

          ğŸ  Homeserver: {{ matrix_homeserver_name }}
          ğŸŒ Domain: {{ matrix_domain }}
          ğŸ”’ SSL: {{ 'Enabled' if ssl_domains is defined else 'Manual setup required' }}
          ğŸ”¥ Firewall: {{ 'Configured' if ufw_enabled else 'Manual setup required' }}
          ğŸ“Š Monitoring: {{ 'Enabled' if monitoring_enabled else 'Disabled' }}

          ğŸ”— Element Web: https://{{ matrix_domain }}
          ğŸ”— Synapse Admin: https://{{ matrix_homeserver_name }}/_synapse/admin/
          ğŸ”— Federation Check: https://{{ matrix_homeserver_name }}/_matrix/federation/v1/version

          ğŸ“‹ Next Steps:
          1. Create admin user: /usr/local/bin/create-matrix-admin.sh <username> <password>
          2. Test federation: https://federationtester.matrix.org/
          3. Configure DNS records if not done already
          4. Review security settings in /etc/matrix-synapse/homeserver.yaml
          5. Set up monitoring alerts

          ğŸ“ Important Files:
          - Synapse config: /etc/matrix-synapse/homeserver.yaml
          - Caddy config: /etc/caddy/Caddyfile
          - SSL certificates: /etc/letsencrypt/live/{{ matrix_domain }}/
          - Logs: /var/log/matrix-synapse/

          âš ï¸  Security Reminders:
          - Change default passwords in vault file
          - Enable registration token if needed
          - Review firewall rules
          - Monitor system resources
          - Set up regular backups
      tags: ['summary']