# Additional iptables security rules
# These rules complement UFW for enhanced security

# Drop invalid packets
-A INPUT -m state --state INVALID -j DROP

# Allow loopback traffic
-A INPUT -i lo -j ACCEPT
-A OUTPUT -o lo -j ACCEPT

# Allow established and related connections
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# Rate limit new SSH connections
-A INPUT -p tcp --dport {{ ssh_port | default(2222) }} -m state --state NEW -m recent --set --name ssh --rsource
-A INPUT -p tcp --dport {{ ssh_port | default(2222) }} -m state --state NEW -m recent --update --seconds 60 --hitcount 4 --rttl --name ssh --rsource -j LOG --log-prefix "SSH_RATE_LIMIT: " --log-level 7
-A INPUT -p tcp --dport {{ ssh_port | default(2222) }} -m state --state NEW -m recent --update --seconds 60 --hitcount 4 --rttl --name ssh --rsource -j DROP

# Drop packets with bogus TCP flags
-A INPUT -p tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG NONE -j DROP
-A INPUT -p tcp --tcp-flags FIN,SYN FIN,SYN -j DROP
-A INPUT -p tcp --tcp-flags SYN,RST SYN,RST -j DROP
-A INPUT -p tcp --tcp-flags FIN,RST FIN,RST -j DROP
-A INPUT -p tcp --tcp-flags FIN,ACK FIN -j DROP
-A INPUT -p tcp --tcp-flags ACK,URG URG -j DROP

# Drop NULL packets
-A INPUT -p tcp --tcp-flags ALL NONE -j DROP

# Drop XMAS packets
-A INPUT -p tcp --tcp-flags ALL ALL -j DROP

# Drop packets with MSS anomalies
-A INPUT -p tcp -m tcp --tcp-flags SYN,RST SYN -m tcpmss ! --mss 536:65535 -j DROP

# Protect against port scanning
-A INPUT -m recent --name portscan --rcheck --seconds 86400 -j DROP
-A INPUT -m recent --name portscan --remove
-A INPUT -p tcp -m tcp --dport 139 -m recent --name portscan --set -j LOG --log-prefix "PORT_SCAN: " --log-level 7
-A INPUT -p tcp -m tcp --dport 139 -m recent --name portscan --set -j DROP

# Log and drop everything else
-A INPUT -j LOG --log-prefix "IPTABLES_DENIED: " --log-level 7
-A INPUT -j DROP