# Matrix Synapse Homeserver Configuration
# Generated by Ansible

# Server configuration
server_name: "{{ matrix_homeserver_name }}"
public_baseurl: "https://{{ matrix_homeserver_name }}"
serve_server_wellknown: true

# Listening configuration
listeners:
  - port: 8008
    tls: false
    type: http
    x_forwarded: true
    bind_addresses: ['127.0.0.1']
    resources:
      - names: [client, federation]
        compress: false
{% if matrix_metrics_enabled %}
  - port: {{ matrix_metrics_port }}
    type: metrics
    bind_addresses: ['127.0.0.1']
{% endif %}

# Database configuration
database:
  name: psycopg2
  args:
    user: "{{ matrix_database_user }}"
    password: "{{ matrix_database_password }}"
    database: "{{ matrix_database_name }}"
    host: "{{ matrix_database_host }}"
    port: {{ matrix_database_port }}
    cp_min: 5
    cp_max: 10

# Redis configuration (if enabled)
{% if matrix_redis_enabled %}
redis:
  enabled: true
  host: "{{ matrix_redis_host }}"
  port: {{ matrix_redis_port }}
{% if matrix_redis_password %}
  password: "{{ matrix_redis_password }}"
{% endif %}
{% endif %}

# Logging configuration - Privacy focused (no IP logging)
log_config: "/etc/matrix-synapse/log.yaml"

# Media store configuration
media_store_path: "{{ matrix_media_store_path }}"
max_upload_size: "{{ matrix_max_upload_size }}"
max_image_pixels: {{ matrix_max_image_pixels }}

# Media retention (cleanup after 90 days)
{% if matrix_media_cleanup_enabled %}
media_retention:
  local_media_lifetime: "{{ matrix_media_retention_days }}d"
  remote_media_lifetime: "{{ matrix_media_retention_days }}d"
{% endif %}

# Registration configuration - NO EMAIL OR CAPTCHA REQUIRED
enable_registration: {{ matrix_registration_enabled | lower }}
registration_requires_token: {{ matrix_registration_enabled | lower }}
{% if matrix_registration_shared_secret %}
registration_shared_secret: "{{ matrix_registration_shared_secret }}"
{% endif %}

# Explicitly disable email and captcha requirements
enable_registration_captcha: false
registration_requires_email: false
require_auth_for_profile_requests: {{ matrix_require_auth_for_profile_requests | lower }}
limit_profile_requests_to_users_who_share_rooms: {{ matrix_limit_profile_requests_to_users_who_share_rooms | lower }}

# Guest access configuration
allow_guest_access: {{ matrix_guest_access_enabled | lower }}
enable_registration_captcha: false

# Privacy settings - Presence enabled as requested
presence:
  enabled: {{ matrix_presence_enabled | lower }}

# Federation settings
federation_domain_whitelist: []
federation_client_minimum_tls_version: "1.2"

# Security settings
bcrypt_rounds: {{ matrix_bcrypt_rounds }}
form_secret: "{{ vault_form_secret | default('changeme') }}"
macaroon_secret_key: "{{ vault_macaroon_secret_key | default('changeme') }}"
signing_key_path: "/etc/matrix-synapse/signing.key"

# Trusted key servers for federation
trusted_key_servers:
{% for server in matrix_trusted_key_servers %}
  - server_name: "{{ server.server_name }}"
    verify_keys:
{% for key, value in server.verify_keys.items() %}
      "{{ key }}": "{{ value }}"
{% endfor %}
{% endfor %}

# Rate limiting
rc_message:
  per_second: {{ matrix_rc_message_per_second }}
  burst_count: {{ matrix_rc_message_burst_count }}

rc_registration:
  per_second: {{ matrix_rc_registration_per_second }}
  burst_count: {{ matrix_rc_registration_burst_count }}

# Message retention and redaction - 5 minute redaction window
redaction_retention_period: {{ matrix_redaction_retention_period }}s

# NO MESSAGE RETENTION BY DEFAULT (preserves all messages)
{% if matrix_message_retention_policy %}
retention:
  enabled: true
  default_policy:
    min_lifetime: {{ matrix_retention_default_min_lifetime }}
    max_lifetime: {{ matrix_retention_default_max_lifetime }}
{% endif %}

# URL previews disabled for privacy
url_preview_enabled: {{ matrix_url_preview_enabled | lower }}
{% if matrix_url_preview_enabled %}
url_preview_ip_range_blacklist:
{% for range in matrix_url_preview_ip_range_blacklist %}
  - "{{ range }}"
{% endfor %}
{% endif %}

# Push notifications
push:
  include_content: false  # Don't include message content in push notifications

# Metrics (for monitoring)
{% if matrix_metrics_enabled %}
enable_metrics: true
{% endif %}

# TURN server configuration
{% if matrix_coturn_enabled %}
turn_uris:
  - "turn:{{ matrix_coturn_external_ip }}:3478?transport=udp"
  - "turn:{{ matrix_coturn_external_ip }}:3478?transport=tcp"
turn_shared_secret: "{{ matrix_coturn_secret }}"
turn_user_lifetime: 86400000
turn_allow_guests: false
{% endif %}

# Admin contact
admin_contact: "{{ matrix_admin_contact }}"

# Additional privacy settings
require_auth_for_profile_requests: true
limit_profile_requests_to_users_who_share_rooms: true
allow_public_rooms_without_auth: false
allow_public_rooms_over_federation: false

# Encryption settings - ensure admin cannot access encrypted content
encryption_enabled_by_default_for_room_type: "all"

# Room directory over federation
allow_public_rooms_over_federation: {{ matrix_federation_enabled | lower }}

# Event cache size (performance)
event_cache_size: "10K"

# User directory settings
user_directory:
  enabled: true
  search_all_users: false
  prefer_local_users: true