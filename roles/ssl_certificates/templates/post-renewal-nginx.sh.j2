#!/bin/bash
# Post-renewal hook for nginx

set -euo pipefail

LOG_FILE="/var/log/ssl-renewal.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "Post-renewal hook: Testing nginx configuration"

# Test nginx configuration
if nginx -t > /dev/null 2>&1; then
    log "Post-renewal hook: Nginx configuration test passed"

    # Reload nginx
    if systemctl reload nginx; then
        log "Post-renewal hook: Nginx reloaded successfully"
    else
        log "Post-renewal hook: ERROR - Failed to reload nginx"
        exit 1
    fi
else
    log "Post-renewal hook: ERROR - Nginx configuration test failed"
    exit 1
fi

log "Post-renewal hook: Completed successfully"