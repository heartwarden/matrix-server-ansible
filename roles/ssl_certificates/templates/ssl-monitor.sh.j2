#!/bin/bash
# SSL Certificate Monitoring Script

set -euo pipefail

LOG_FILE="/var/log/ssl-monitor.log"
ALERT_DAYS=30
CRITICAL_DAYS=7

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

check_certificate() {
    local domain=$1
    local cert_file="/etc/letsencrypt/live/$domain/cert.pem"

    if [[ ! -f "$cert_file" ]]; then
        log "WARNING: Certificate file not found for $domain"
        return 1
    fi

    # Get certificate expiration date
    local expiry_date=$(openssl x509 -enddate -noout -in "$cert_file" | cut -d= -f2)
    local expiry_epoch=$(date -d "$expiry_date" +%s)
    local current_epoch=$(date +%s)
    local days_until_expiry=$(( (expiry_epoch - current_epoch) / 86400 ))

    log "Certificate for $domain expires in $days_until_expiry days ($expiry_date)"

    if [[ $days_until_expiry -le $CRITICAL_DAYS ]]; then
        log "CRITICAL: Certificate for $domain expires in $days_until_expiry days!"
        # Send alert (implement your preferred alerting method)
        return 2
    elif [[ $days_until_expiry -le $ALERT_DAYS ]]; then
        log "WARNING: Certificate for $domain expires in $days_until_expiry days"
        # Send warning (implement your preferred alerting method)
        return 1
    else
        log "Certificate for $domain is valid for $days_until_expiry more days"
        return 0
    fi
}

log "Starting SSL certificate monitoring"

exit_code=0

{% if ssl_domains is defined and ssl_domains | length > 0 %}
{% for domain in ssl_domains %}
if ! check_certificate "{{ domain }}"; then
    exit_code=1
fi
{% endfor %}
{% else %}
log "No domains configured for monitoring"
{% endif %}

# Check certificate chain validity
{% if ssl_domains is defined and ssl_domains | length > 0 %}
for domain in {{ ssl_domains | join(' ') }}; do
    cert_file="/etc/letsencrypt/live/$domain/fullchain.pem"
    if [[ -f "$cert_file" ]]; then
        if openssl verify -CAfile "$cert_file" "$cert_file" > /dev/null 2>&1; then
            log "Certificate chain for $domain is valid"
        else
            log "ERROR: Certificate chain for $domain is invalid"
            exit_code=1
        fi
    fi
done
{% endif %}

log "SSL certificate monitoring completed with exit code: $exit_code"
exit $exit_code