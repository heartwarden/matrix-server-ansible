#!/bin/bash
# SSL Certificate Renewal Script

set -euo pipefail

LOG_FILE="/var/log/ssl-renewal.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')

log() {
    echo "[$DATE] $1" | tee -a "$LOG_FILE"
}

log "Starting SSL certificate renewal check"

# Check if any certificates need renewal
if /usr/bin/certbot renew --quiet --no-self-upgrade; then
    log "Certificate renewal check completed successfully"

    # Test Caddy configuration
    if caddy validate --config {{ caddy_config_file }} > /dev/null 2>&1; then
        log "Caddy configuration test passed"

        # Reload Caddy
        if systemctl reload caddy; then
            log "Caddy reloaded successfully"
        else
            log "ERROR: Failed to reload Caddy"
            exit 1
        fi
    else
        log "ERROR: Caddy configuration test failed"
        exit 1
    fi
else
    log "ERROR: Certificate renewal failed"
    exit 1
fi

{% if ssl_backup_enabled %}
# Run backup after successful renewal
if [ -f "/usr/local/bin/ssl-backup.sh" ]; then
    log "Running SSL certificate backup"
    /usr/local/bin/ssl-backup.sh
fi
{% endif %}

log "SSL renewal process completed"