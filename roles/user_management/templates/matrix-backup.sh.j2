#!/bin/bash
# Matrix server backup script for {{ admin_username }}

BACKUP_DIR="/var/backups/matrix"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="matrix_backup_$DATE.tar.gz"

echo "Starting Matrix server backup..."

# Create backup directory
sudo mkdir -p "$BACKUP_DIR"

# Stop services for consistent backup
echo "Stopping Matrix services..."
sudo systemctl stop matrix-synapse

# Create backup
echo "Creating backup archive..."
sudo tar -czf "$BACKUP_DIR/$BACKUP_FILE" \
    /var/lib/matrix-synapse \
    /etc/matrix-synapse \
    /etc/caddy \
    /var/lib/postgresql \
    /etc/postgresql \
    /var/log/matrix-synapse \
    2>/dev/null

# Restart services
echo "Restarting Matrix services..."
sudo systemctl start matrix-synapse

# Set permissions
sudo chmod 600 "$BACKUP_DIR/$BACKUP_FILE"
sudo chown root:root "$BACKUP_DIR/$BACKUP_FILE"

# Clean old backups (keep last 7 days)
sudo find "$BACKUP_DIR" -name "matrix_backup_*.tar.gz" -mtime +7 -delete 2>/dev/null

# Get backup size
BACKUP_SIZE=$(sudo du -h "$BACKUP_DIR/$BACKUP_FILE" | cut -f1)

echo "Backup completed successfully!"
echo "File: $BACKUP_DIR/$BACKUP_FILE"
echo "Size: $BACKUP_SIZE"
echo "Services restarted."