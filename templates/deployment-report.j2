=====================================
MATRIX SERVER DEPLOYMENT REPORT
=====================================

Deployment Date: {{ deployment_time }}
Target Server: {{ inventory_hostname }}
Matrix Domain: {{ matrix_domain }}
Homeserver: {{ matrix_homeserver_name }}
Admin User: {{ vault_admin_username }}

=====================================
SERVICE STATUS
=====================================

{% for service in services %}
{{ "✅" if service.status.ActiveState == "active" else "❌" }} {{ service.item }}: {{ service.status.ActiveState | default("unknown") }}
{% if service.status.SubState is defined %}   SubState: {{ service.status.SubState }}{% endif %}
{% if service.failed and service.msg is defined %}   Error: {{ service.msg }}{% endif %}
{% endfor %}

=====================================
PORT CONNECTIVITY
=====================================

{% for port in ports %}
{{ "✅" if port.state is defined and port.state == "started" else "❌" }} Port {{ port.item.port }} ({{ port.item.service | default("service") }}): {{ "Open" if port.state is defined and port.state == "started" else "Closed/Timeout" }}
{% if port.failed and port.msg is defined %}   Error: {{ port.msg }}{% endif %}
{% endfor %}

=====================================
API TESTS
=====================================

{{ "✅" if matrix_test.status is defined and matrix_test.status == 200 else "❌" }} Local Matrix API: {{ "Working" if matrix_test.status is defined and matrix_test.status == 200 else "Failed" }}
{% if matrix_test.failed and matrix_test.msg is defined %}   Error: {{ matrix_test.msg }}{% endif %}

{{ "✅" if federation.status is defined and federation.status == 200 else "❌" }} Federation API: {{ "Working" if federation.status is defined and federation.status == 200 else "Check DNS/SSL" }}
{% if federation.failed and federation.msg is defined %}   Error: {{ federation.msg }}{% endif %}

=====================================
IMPORTANT URLS
=====================================

📱 Element Web Client: https://{{ matrix_domain }}
🔧 Synapse Admin: https://{{ matrix_homeserver_name }}/_synapse/admin/
🔗 Federation Endpoint: https://{{ matrix_homeserver_name }}/_matrix/federation/v1/version
🧪 Federation Tester: https://federationtester.matrix.org/

=====================================
NEXT STEPS
=====================================

1. Create admin user:
   sudo /usr/local/bin/create-matrix-admin.sh {{ vault_admin_username }} "{{ vault_admin_password }}"

2. Test Element web client:
   Open: https://{{ matrix_domain }}

3. Test federation (if public):
   Use: https://federationtester.matrix.org/

4. DNS Configuration (if needed):
   {{ matrix_domain }} → {{ ansible_default_ipv4.address | default("YOUR_SERVER_IP") }}
   {{ matrix_homeserver_name }} → {{ ansible_default_ipv4.address | default("YOUR_SERVER_IP") }}

=====================================
IMPORTANT FILES & COMMANDS
=====================================

📁 Configuration:
   - Homeserver: /etc/matrix-synapse/homeserver.yaml
   - Element: /var/www/element/config.json
   - Caddy: /etc/caddy/Caddyfile
   - SSL Certs: /var/lib/caddy/.local/share/caddy/certificates/

📊 Monitoring:
   - Logs: journalctl -u matrix-synapse -f
   - Status: systemctl status matrix-synapse caddy postgresql redis-server
   - Processes: ps aux | grep -E "synapse|caddy|postgres|redis"

🔧 Administration:
   - Admin script: /usr/local/bin/create-matrix-admin.sh
   - Backup script: /usr/local/bin/backup-matrix.sh
   - Media cleanup: /usr/local/bin/cleanup-matrix-media.sh

=====================================
SECURITY NOTES
=====================================

✅ SSH hardened (port {{ ssh_port | default(2222) }})
✅ Firewall configured (UFW)
✅ Fail2Ban active
✅ SSL certificates auto-renewing
✅ Regular security updates enabled
✅ Privacy settings configured (no IP logging)
✅ Media auto-cleanup after {{ matrix_media_retention_days | default(90) }} days
✅ Message redaction window: {{ matrix_redaction_retention_period | default(300) }} seconds

=====================================
TROUBLESHOOTING
=====================================

If services are not working:

1. Check logs:
   journalctl -u matrix-synapse -n 50
   journalctl -u caddy -n 50

2. Test database:
   sudo -u postgres psql -d synapse -c "SELECT version();"

3. Test Matrix API:
   curl -k http://localhost:8008/_matrix/client/versions

4. Restart services:
   systemctl restart matrix-synapse caddy

5. Check firewall:
   ufw status verbose

=====================================
BACKUP INFORMATION
=====================================

{% if matrix_backup_enabled | default(true) %}
🔄 Automatic backups: Enabled
📅 Schedule: {{ matrix_backup_schedule | default("0 2 * * *") }}
📂 Location: /var/backups/matrix/
🗓️  Retention: {{ matrix_backup_retention_days | default(7) }} days
{% else %}
⚠️  Automatic backups: Disabled
{% endif %}

To manually backup:
sudo /usr/local/bin/backup-matrix.sh

=====================================
END OF REPORT
=====================================

Report generated: {{ ansible_date_time.iso8601 }}
Ansible managed: {{ ansible_managed | default("yes") }}